<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNG Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .file-item:hover .file-actions {
            opacity: 1;
        }
        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .dropzone {
            border: 2px dashed #ccc;
            transition: all 0.3s;
        }
        .dropzone.active {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .context-menu {
            display: none;
            position: absolute;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.25rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        .context-menu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            white-space: nowrap;
        }
        .context-menu-item:hover {
            background-color: #4a5568;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        .image-container {
            aspect-ratio: 1/1;
            overflow: hidden;
        }
        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }
        .image-container:hover img {
            transform: scale(1.05);
        }
        .image-title {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.5rem;
        }
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .image-viewer.active {
            opacity: 1;
            pointer-events: all;
        }
        .image-viewer img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .image-viewer-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .image-viewer-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .image-viewer-prev {
            left: 1rem;
        }
        .image-viewer-next {
            right: 1rem;
        }
        .image-viewer-title {
            position: absolute;
            bottom: 2rem;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 0 2rem;
        }
        .edit-name-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid white;
            color: white;
            text-align: center;
            width: 80%;
            margin: 0 auto;
            font-size: inherit;
        }
        .edit-name-input:focus {
            outline: none;
            border-bottom-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h1 class="text-xl font-bold">Skin Gallery</h1>
                <div class="language-switcher">
                    <button id="switch-language" class="bg-gray-700 hover:bg-gray-600 rounded-full w-8 h-8 flex items-center justify-center">
                        <span class="text-sm">EN</span>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto">
                <div class="p-2">
                    <!-- Кнопка створення категорії видалена -->
                </div>
                <div id="category-list" class="p-2">
                    <!-- Categories will be added here -->
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Toolbar -->
            <div class="bg-gray-800 p-3 border-b border-gray-700 flex items-center justify-between">
                <div class="flex items-center">
                    <button id="back-btn" class="mr-2 text-gray-400 hover:text-white">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 id="current-category" class="text-lg font-semibold" data-i18n="all_images">Всё изображения</h2>
                </div>
                <div>
                    <!-- Кнопка завантаження файлів видалена -->
                </div>
            </div>

            <!-- File Browser -->
            <div id="file-browser" class="flex-1 overflow-y-auto p-4 image-grid">
                <!-- Files will be displayed here -->
                <div id="empty-state" class="col-span-full text-center py-10 text-gray-400">
                    <i class="fas fa-images text-4xl mb-2"></i>
                    <p data-i18n="no_images">Нету скинов</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Viewer -->
    <div id="image-viewer" class="image-viewer">
        <button class="image-viewer-close">
            <i class="fas fa-times"></i>
        </button>
        <button class="image-viewer-nav image-viewer-prev">
            <i class="fas fa-chevron-left"></i>
        </button>
        <img id="viewed-image" src="" alt="">
        <button class="image-viewer-nav image-viewer-next">
            <i class="fas fa-chevron-right"></i>
        </button>
        <div id="image-viewer-title" class="image-viewer-title"></div>
    </div>

    <!-- Context Menu -->
    <div id="category-context-menu" class="context-menu">
        <div class="context-menu-item" id="delete-category-btn" data-i18n="delete_category">Видалити категорію</div>
    </div>

    <!-- Modals -->
    <div id="new-category-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 rounded-lg p-6 w-96">
            <h3 class="text-xl font-bold mb-4" data-i18n="new_category">Нова категорія</h3>
            <input type="text" id="category-name" placeholder="Назва категорії" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 mb-4">
            <div class="flex justify-end space-x-2">
                <button id="cancel-category" class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-700" data-i18n="cancel">Скасувати</button>
                <button id="save-category" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700" data-i18n="save">Зберегти</button>
            </div>
        </div>
    </div>

    <div id="upload-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 rounded-lg p-6 w-96">
            <h3 class="text-xl font-bold mb-4" data-i18n="upload_images">Завантажити зображення</h3>
            <div id="dropzone" class="dropzone rounded-lg p-10 text-center mb-4 cursor-pointer">
                <i class="fas fa-cloud-upload-alt text-4xl mb-2 text-gray-400"></i>
                <p data-i18n="drag_files">Перетягніть файли сюди або</p>
                <p class="text-sm text-gray-400" data-i18n="only_png">(тільки PNG файли)</p>
                <button id="select-files" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded">
                    <span data-i18n="select_files">Обрати файли</span>
                </button>
                <input type="file" id="file-input" class="hidden" accept="image/png" multiple>
            </div>
            <div id="upload-progress" class="hidden">
                <div class="w-full bg-gray-700 rounded-full h-2.5 mb-2">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-sm text-gray-400">0% <span data-i18n="completed">завершено</span></p>
            </div>
            <div class="flex justify-end space-x-2 mt-4">
                <button id="cancel-upload" class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-700" data-i18n="cancel">Скасувати</button>
                <button id="start-upload" class="px-4 py-2 rounded bg-green-600 hover:bg-green-700 hidden" data-i18n="start_upload">Почати завантаження</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 rounded-lg p-6 w-96">
            <h3 class="text-xl font-bold mb-4" id="confirm-title">Підтвердіть дію</h3>
            <p id="confirm-message">Ви впевнені, що хочете видалити цю категорію?</p>
            <div class="flex justify-end space-x-2 mt-6">
                <button id="confirm-cancel" class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-700" data-i18n="cancel">Скасувати</button>
                <button id="confirm-ok" class="px-4 py-2 rounded bg-red-600 hover:bg-red-700" data-i18n="delete">Видалити</button>
            </div>
        </div>
    </div>

    <div id="edit-name-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 rounded-lg p-6 w-96">
            <h3 class="text-xl font-bold mb-4" data-i18n="edit_name">Редагувати назву</h3>
            <input type="text" id="edit-name-input" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 mb-4">
            <div class="flex justify-end space-x-2">
                <button id="cancel-edit-name" class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-700" data-i18n="cancel">Скасувати</button>
                <button id="save-edit-name" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700" data-i18n="save">Зберегти</button>
            </div>
        </div>
    </div>

    <script>
        // App state
        const state = {
            categories: JSON.parse(localStorage.getItem('categories')) || [],
            files: JSON.parse(localStorage.getItem('files')) || [],
            currentCategory: null,
            selectedFiles: [],
            language: localStorage.getItem('language') || 'uk',
            contextMenuCategory: null,
            currentViewingIndex: -1,
            editingFileId: null,
            selectedLanguage: null
        };

        // Translations
        const translations = {
            uk: {
                select_language: "Виберіть мову",
                new_category: "Нова категорія",
                all_images: "Всі зображення",
                upload: "Завантажити",
                no_images: "Немає зображень. Завантажте свої PNG файли.",
                delete_category: "Видалити категорію",
                cancel: "Скасувати",
                save: "Зберегти",
                upload_images: "Завантажити зображення",
                drag_files: "Перетягніть файли сюди або",
                only_png: "(тільки PNG файли)",
                select_files: "Обрати файли",
                completed: "завершено",
                start_upload: "Почати завантаження",
                delete: "Видалити",
                confirm_delete_category: "Ви впевнені, що хочете видалити цю категорію? Усі зображення в ній також будуть видалені.",
                link_copied: "Посилання скопійовано!",
                delete_image: "Видалити зображення",
                confirm_delete_image: "Видалити це зображення?",
                edit_name: "Редагувати назву",
                edit: "Редагувати",
                view_image: "Переглянути",
                no_name: "Без назви",
                confirm: "Підтвердити",
                copy_link: "Копіювати посилання",
                all_categories: "Всі категорії",
                no_images_in_category: "Немає зображень у цій категорії",
                confirm_action: "Підтвердіть дію"
            },
            en: {
                select_language: "Select Language",
                new_category: "New Category",
                all_images: "All Images",
                upload: "Upload",
                no_images: "No images. Upload your PNG files.",
                delete_category: "Delete Category",
                cancel: "Cancel",
                save: "Save",
                upload_images: "Upload Images",
                drag_files: "Drag files here or",
                only_png: "(PNG files only)",
                select_files: "Select Files",
                completed: "completed",
                start_upload: "Start Upload",
                delete: "Delete",
                confirm_delete_category: "Are you sure you want to delete this category? All images in it will also be deleted.",
                link_copied: "Link copied!",
                delete_image: "Delete Image",
                confirm_delete_image: "Delete this image?",
                edit_name: "Edit Name",
                edit: "Edit",
                view_image: "View",
                no_name: "No Name",
                confirm: "Confirm",
                copy_link: "Copy Link",
                all_categories: "All Categories",
                no_images_in_category: "No images in this category",
                confirm_action: "Confirm Action"
            },
            ru: {
                select_language: "Выберите язык",
                new_category: "Новая категория",
                all_images: "Все изображения",
                upload: "Загрузить",
                no_images: "Нет изображений. Загрузите свои PNG файлы.",
                delete_category: "Удалить категорию",
                cancel: "Отмена",
                save: "Сохранить",
                upload_images: "Загрузить изображения",
                drag_files: "Перетащите файлы сюда или",
                only_png: "(только PNG файлы)",
                select_files: "Выбрать файлы",
                completed: "завершено",
                start_upload: "Начать загрузку",
                delete: "Удалить",
                confirm_delete_category: "Вы уверены, что хотите удалить эту категорию? Все изображения в ней также будут удалены.",
                link_copied: "Ссылка скопирована!",
                delete_image: "Удалить изображение",
                confirm_delete_image: "Удалить это изображение?",
                edit_name: "Редактировать название",
                edit: "Редактировать",
                view_image: "Просмотреть",
                no_name: "Без названия",
                confirm: "Подтвердить",
                copy_link: "Копировать ссылку",
                all_categories: "Все категории",
                no_images_in_category: "Нет изображений в этой категории",
                confirm_action: "Подтвердите действие"
            }
        };

        // DOM elements
        const elements = {
            categoryList: document.getElementById('category-list'),
            fileBrowser: document.getElementById('file-browser'),
            emptyState: document.getElementById('empty-state'),
            currentCategory: document.getElementById('current-category'),
            newCategoryBtn: document.getElementById('new-category-btn'),
            newCategoryModal: document.getElementById('new-category-modal'),
            categoryName: document.getElementById('category-name'),
            cancelCategory: document.getElementById('cancel-category'),
            saveCategory: document.getElementById('save-category'),
            uploadBtn: document.getElementById('upload-btn'),
            uploadModal: document.getElementById('upload-modal'),
            dropzone: document.getElementById('dropzone'),
            selectFiles: document.getElementById('select-files'),
            fileInput: document.getElementById('file-input'),
            cancelUpload: document.getElementById('cancel-upload'),
            startUpload: document.getElementById('start-upload'),
            uploadProgress: document.getElementById('upload-progress'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            backBtn: document.getElementById('back-btn'),
            switchLanguage: document.getElementById('switch-language'),
            contextMenu: document.getElementById('category-context-menu'),
            deleteCategoryBtn: document.getElementById('delete-category-btn'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmTitle: document.getElementById('confirm-title'),
            confirmMessage: document.getElementById('confirm-message'),
            confirmCancel: document.getElementById('confirm-cancel'),
            confirmOk: document.getElementById('confirm-ok'),
            imageViewer: document.getElementById('image-viewer'),
            viewedImage: document.getElementById('viewed-image'),
            imageViewerClose: document.querySelector('.image-viewer-close'),
            imageViewerPrev: document.querySelector('.image-viewer-prev'),
            imageViewerNext: document.querySelector('.image-viewer-next'),
            imageViewerTitle: document.getElementById('image-viewer-title'),
            editNameModal: document.getElementById('edit-name-modal'),
            editNameInput: document.getElementById('edit-name-input'),
            cancelEditName: document.getElementById('cancel-edit-name'),
            saveEditName: document.getElementById('save-edit-name'),
            languageModal: document.getElementById('language-modal'),
            languageOptions: document.querySelectorAll('.language-option'),
            confirmLanguage: document.getElementById('confirm-language')
        };

        // Initialize the app
        function init() {
            // Перевіряємо, чи є збережена мова
            const savedLanguage = localStorage.getItem('language');
            if (!savedLanguage) {
                // Якщо немає збереженої мови, показуємо модальне вікно
                elements.languageModal.classList.remove('hidden');
            } else {
                state.language = savedLanguage;
                applyLanguage();
            }
            renderCategories();
            renderFiles();
            setupEventListeners();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Category management
            elements.newCategoryBtn.addEventListener('click', () => {
                elements.newCategoryModal.classList.remove('hidden');
                elements.categoryName.focus();
            });

            elements.cancelCategory.addEventListener('click', () => {
                elements.newCategoryModal.classList.add('hidden');
                elements.categoryName.value = '';
            });

            elements.saveCategory.addEventListener('click', addCategory);

            elements.categoryName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addCategory();
            });

            // File upload
            elements.uploadBtn.addEventListener('click', () => {
                elements.uploadModal.classList.remove('hidden');
            });

            elements.cancelUpload.addEventListener('click', () => {
                elements.uploadModal.classList.add('hidden');
                resetUploadForm();
            });

            elements.selectFiles.addEventListener('click', () => {
                elements.fileInput.click();
            });

            elements.fileInput.addEventListener('change', (e) => {
                handleFileSelection(e.target.files);
            });

            elements.startUpload.addEventListener('click', uploadFiles);

            // Drag and drop
            elements.dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.dropzone.classList.add('active');
            });

            elements.dropzone.addEventListener('dragleave', () => {
                elements.dropzone.classList.remove('active');
            });

            elements.dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.dropzone.classList.remove('active');
                const files = e.dataTransfer.files;
                handleFileSelection(files);
            });

            // Navigation
            elements.backBtn.addEventListener('click', () => {
                state.currentCategory = null;
                translateElement(elements.currentCategory, 'all_images');
                renderFiles();
            });

            // Language switcher
            elements.switchLanguage.addEventListener('click', () => {
                elements.languageModal.classList.remove('hidden');
            });

            // Context menu
            document.addEventListener('click', () => {
                elements.contextMenu.style.display = 'none';
            });

            elements.deleteCategoryBtn.addEventListener('click', () => {
                elements.contextMenu.style.display = 'none';
                showConfirmModal(
                    translate('confirm_delete_category'),
                    () => {
                        deleteCategory(state.contextMenuCategory);
                    }
                );
            });

            // Confirm modal
            elements.confirmCancel.addEventListener('click', () => {
                elements.confirmModal.classList.add('hidden');
            });

            elements.confirmOk.addEventListener('click', () => {
                if (typeof state.confirmCallback === 'function') {
                    state.confirmCallback();
                }
                elements.confirmModal.classList.add('hidden');
            });

            // Image viewer
            elements.imageViewerClose.addEventListener('click', () => {
                elements.imageViewer.classList.remove('active');
            });

            elements.imageViewerPrev.addEventListener('click', showPrevImage);
            elements.imageViewerNext.addEventListener('click', showNextImage);

            // Edit name modal
            elements.cancelEditName.addEventListener('click', () => {
                elements.editNameModal.classList.add('hidden');
            });

            elements.saveEditName.addEventListener('click', saveFileName);

            elements.editNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveFileName();
            });

            // Keyboard navigation for image viewer
            document.addEventListener('keydown', (e) => {
                if (elements.imageViewer.classList.contains('active')) {
                    if (e.key === 'Escape') {
                        elements.imageViewer.classList.remove('active');
                    } else if (e.key === 'ArrowLeft') {
                        showPrevImage();
                    } else if (e.key === 'ArrowRight') {
                        showNextImage();
                    }
                }
            });

            // Language selection
            elements.languageOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // Видаляємо активний клас з усіх опцій
                    elements.languageOptions.forEach(opt => opt.classList.remove('bg-blue-600'));
                    // Додаємо активний клас до вибраної опції
                    option.classList.add('bg-blue-600');
                    // Зберігаємо вибрану мову
                    state.selectedLanguage = option.getAttribute('data-lang');
                });
            });

            elements.confirmLanguage.addEventListener('click', () => {
                if (state.selectedLanguage) {
                    state.language = state.selectedLanguage;
                    localStorage.setItem('language', state.language);
                    applyLanguage();
                    elements.languageModal.classList.add('hidden');
                    // Оновлюємо текст на кнопці перемикання мови
                    elements.switchLanguage.innerHTML = `<span class="text-sm">${state.language.toUpperCase()}</span>`;
                }
            });
        }

        // Language functions
        function applyLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[state.language] && translations[state.language][key]) {
                    el.textContent = translations[state.language][key];
                }
            });
        }

        function translate(key) {
            return translations[state.language]?.[key] || key;
        }

        function translateElement(element, key) {
            if (element) {
                element.textContent = translate(key);
            }
        }

        // Handle file selection
        function handleFileSelection(files) {
            const pngFiles = Array.from(files).filter(file => file.type === 'image/png');
            
            if (pngFiles.length === 0) {
                alert(state.language === 'uk' 
                    ? 'Будь ласка, оберіть PNG файли.' 
                    : 'Пожалуйста, выберите PNG файлы.');
                return;
            }

            state.selectedFiles = pngFiles;
            elements.startUpload.classList.remove('hidden');
        }

        // Upload files
        function uploadFiles() {
            if (state.selectedFiles.length === 0) return;

            elements.startUpload.classList.add('hidden');
            elements.uploadProgress.classList.remove('hidden');

            let uploadedCount = 0;
            const totalFiles = state.selectedFiles.length;

            state.selectedFiles.forEach((file, index) => {
                // In a real app, you would upload to a server here
                // For this demo, we'll simulate upload and use FileReader to get data URL
                const reader = new FileReader();

                reader.onload = (e) => {
                    const fileName = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
                    
                    const fileData = {
                        id: Date.now() + index,
                        name: fileName,
                        originalName: file.name,
                        category: state.currentCategory,
                        url: e.target.result,
                        date: new Date().toISOString()
                    };

                    state.files.push(fileData);
                    localStorage.setItem('files', JSON.stringify(state.files));

                    uploadedCount++;
                    const progress = Math.round((uploadedCount / totalFiles) * 100);
                    updateProgress(progress);

                    if (uploadedCount === totalFiles) {
                        setTimeout(() => {
                            elements.uploadModal.classList.add('hidden');
                            resetUploadForm();
                            renderFiles();
                        }, 500);
                    }
                };

                reader.readAsDataURL(file);
            });
        }

        // Update upload progress
        function updateProgress(percent) {
            elements.progressBar.style.width = `${percent}%`;
            elements.progressText.innerHTML = `${percent}% <span data-i18n="completed">${translate('completed')}</span>`;
        }

        // Reset upload form
        function resetUploadForm() {
            state.selectedFiles = [];
            elements.fileInput.value = '';
            elements.startUpload.classList.add('hidden');
            elements.uploadProgress.classList.add('hidden');
            elements.progressBar.style.width = '0%';
            elements.progressText.innerHTML = `0% <span data-i18n="completed">${translate('completed')}</span>`;
        }

        // Add new category
        function addCategory() {
            const name = elements.categoryName.value.trim();
            if (!name) return;

            const newCategory = {
                id: Date.now(),
                name: name,
                parent: null
            };

            state.categories.push(newCategory);
            localStorage.setItem('categories', JSON.stringify(state.categories));

            elements.newCategoryModal.classList.add('hidden');
            elements.categoryName.value = '';
            renderCategories();
        }

        // Delete category
        function deleteCategory(categoryId) {
            // Remove category
            state.categories = state.categories.filter(cat => cat.id !== categoryId);
            localStorage.setItem('categories', JSON.stringify(state.categories));

            // Remove files in this category
            state.files = state.files.filter(file => file.category !== categoryId);
            localStorage.setItem('files', JSON.stringify(state.files));

            // If we're currently viewing this category, go back to all images
            if (state.currentCategory === categoryId) {
                state.currentCategory = null;
                translateElement(elements.currentCategory, 'all_images');
            }

            renderCategories();
            renderFiles();
        }

        // Show confirm modal
        function showConfirmModal(message, callback) {
            state.confirmCallback = callback;
            elements.confirmMessage.textContent = message;
            translateElement(elements.confirmTitle, 'confirm_action');
            elements.confirmModal.classList.remove('hidden');
        }

        // Render categories list
        function renderCategories() {
            elements.categoryList.innerHTML = '';

            // Add "All" category
            const allItem = document.createElement('div');
            allItem.className = 'sidebar-item flex items-center p-2 rounded cursor-pointer';
            allItem.innerHTML = `
                <i class="fas fa-images mr-2 text-blue-400"></i>
                <span data-i18n="all_images">${translate('all_images')}</span>
            `;
            allItem.addEventListener('click', () => {
                state.currentCategory = null;
                translateElement(elements.currentCategory, 'all_images');
                renderFiles();
            });
            elements.categoryList.appendChild(allItem);

            // Add user categories
            state.categories.forEach(category => {
                const item = document.createElement('div');
                item.className = 'sidebar-item flex items-center p-2 rounded cursor-pointer mt-1';
                item.innerHTML = `
                    <i class="fas fa-folder mr-2 text-yellow-400"></i>
                    <span>${category.name}</span>
                `;
                
                // Add context menu
                item.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    state.contextMenuCategory = category.id;
                    
                    elements.contextMenu.style.display = 'block';
                    elements.contextMenu.style.left = `${e.pageX}px`;
                    elements.contextMenu.style.top = `${e.pageY}px`;
                    
                    // Position adjustment to prevent going off screen
                    const rect = elements.contextMenu.getBoundingClientRect();
                    if (rect.right > window.innerWidth) {
                        elements.contextMenu.style.left = `${window.innerWidth - rect.width - 5}px`;
                    }
                    if (rect.bottom > window.innerHeight) {
                        elements.contextMenu.style.top = `${window.innerHeight - rect.height - 5}px`;
                    }
                });
                
                item.addEventListener('click', () => {
                    state.currentCategory = category.id;
                    elements.currentCategory.textContent = category.name;
                    renderFiles();
                });
                
                elements.categoryList.appendChild(item);
            });
        }

        // Render files
        function renderFiles() {
            elements.fileBrowser.innerHTML = '';
            
            let filesToDisplay = [...state.files];
            
            if (state.currentCategory) {
                filesToDisplay = filesToDisplay.filter(file => file.category === state.currentCategory);
            }
            
            if (filesToDisplay.length === 0) {
                elements.emptyState.classList.remove('hidden');
                elements.fileBrowser.appendChild(elements.emptyState);
                return;
            }
            
            elements.emptyState.classList.add('hidden');
            
            filesToDisplay.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item bg-gray-800 rounded-lg p-3 hover:bg-gray-700 transition-colors fade-in';
                fileItem.style.animationDelay = `${index * 0.05}s`;
                
                fileItem.innerHTML = `
                    <div class="image-container rounded-lg overflow-hidden mb-2">
                        <img src="${file.url}" alt="${file.name}" class="cursor-pointer view-image" data-index="${index}">
                    </div>
                    <div class="image-title text-center mb-2 cursor-pointer view-image" data-index="${index}">
                        ${file.name || translate('no_name')}
                    </div>
                    <div class="file-actions flex justify-center">
                        <button class="copy-btn bg-gray-700 hover:bg-gray-600 rounded-full w-8 h-8 flex items-center justify-center mr-1" title="Копіювати URL" data-url="${window.location.origin}/azubanskins/${file.url}">
                            <i class="fas fa-link text-sm"></i>
                        </button>
                    </div>
                `;
                
                // Add click event for viewing image
                const viewButtons = fileItem.querySelectorAll('.view-image');
                viewButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        state.currentViewingIndex = parseInt(btn.getAttribute('data-index'));
                        showImage(filesToDisplay[state.currentViewingIndex]);
                    });
                });
                
                // Edit button
                const editBtn = fileItem.querySelector('.edit-btn');
                editBtn.addEventListener('click', () => {
                    const fileToEdit = state.files.find(f => f.id === parseInt(editBtn.getAttribute('data-id')));
                    if (fileToEdit) {
                        state.editingFileId = fileToEdit.id;
                        elements.editNameInput.value = fileToEdit.name;
                        elements.editNameModal.classList.remove('hidden');
                        elements.editNameInput.focus();
                    }
                });
                
                // Copy button
                const copyBtn = fileItem.querySelector('.copy-btn');
                copyBtn.addEventListener('click', () => {
                    const url = copyBtn.getAttribute('data-url');
                    copyToClipboard(encodeURL(url));
                    showNotification('Посилання скопійовано!');
                });
                
                // Delete button
                const deleteBtn = fileItem.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', () => {
                    showConfirmModal(
                        translate('confirm_delete_image'),
                        () => {
                            state.files = state.files.filter(f => f.id !== parseInt(deleteBtn.getAttribute('data-id')));
                            localStorage.setItem('files', JSON.stringify(state.files));
                            renderFiles();
                        }
                    );
                });
                
                elements.fileBrowser.appendChild(fileItem);
            });
        }

        // Show image in viewer
        function showImage(file) {
            elements.viewedImage.src = file.url;
            elements.imageViewerTitle.innerHTML = file.name || translate('no_name');
            elements.imageViewer.classList.add('active');
        }

        // Show previous image
        function showPrevImage() {
            let filesToDisplay = [...state.files];
            if (state.currentCategory) {
                filesToDisplay = filesToDisplay.filter(file => file.category === state.currentCategory);
            }
            
            if (filesToDisplay.length === 0) return;
            
            state.currentViewingIndex = (state.currentViewingIndex - 1 + filesToDisplay.length) % filesToDisplay.length;
            showImage(filesToDisplay[state.currentViewingIndex]);
        }

        // Show next image
        function showNextImage() {
            let filesToDisplay = [...state.files];
            if (state.currentCategory) {
                filesToDisplay = filesToDisplay.filter(file => file.category === state.currentCategory);
            }
            
            if (filesToDisplay.length === 0) return;
            
            state.currentViewingIndex = (state.currentViewingIndex + 1) % filesToDisplay.length;
            showImage(filesToDisplay[state.currentViewingIndex]);
        }

        // Save file name
        function saveFileName() {
            const newName = elements.editNameInput.value.trim();
            const fileIndex = state.files.findIndex(f => f.id === state.editingFileId);
            
            if (fileIndex !== -1) {
                state.files[fileIndex].name = newName;
                localStorage.setItem('files', JSON.stringify(state.files));
                renderFiles();
            }
            
            elements.editNameModal.classList.add('hidden');
        }

        // Copy text to clipboard
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }

        // Encode URL properly
        function encodeURL(url) {
            try {
                const urlObj = new URL(url);
                const pathParts = urlObj.pathname.split('/').filter(Boolean);
                const encodedPath = pathParts.map(part => {
                    // Перевіряємо, чи частина вже закодована
                    try {
                        decodeURIComponent(part);
                        return encodeURIComponent(part);
                    } catch (e) {
                        return part; // Якщо не вдається декодувати, значить вже закодовано
                    }
                }).join('/');
                return `${urlObj.origin}/${encodedPath}`;
            } catch (e) {
                return url;
            }
        }

        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-gray-800 border border-gray-700 px-4 py-2 rounded-lg shadow-lg flex items-center';
            notification.innerHTML = `
                <i class="fas fa-check-circle text-green-400 mr-2"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // --- Галерея на основі skins.json ---
        // Категорії = вкладені папки в skins/
        // Зображення = PNG-файли у цих папках
        // Потрібно згенерувати skins.json скриптом generate-skins-json.js

        const CATEGORY_ROOT = 'skins';
        let skinsTree = null;
        let currentPath = [];

        function fetchSkinsJson() {
            return fetch('skins.json').then(r => r.json());
        }

        function buildCategoryTree(node, path = []) {
            const ul = document.createElement('ul');
            ul.className = path.length === 0 ? '' : 'ml-4';
            const li = document.createElement('li');
            li.className = 'sidebar-item flex items-center p-2 rounded cursor-pointer';
            li.textContent = path.length === 0 ? 'Всі категорії' : node.name;
            li.onclick = () => {
                currentPath = [...path];
                renderGallery();
                highlightCategory();
            };
            li.id = 'cat-' + path.join('/');
            ul.appendChild(li);
            if (node.categories) {
                node.categories.forEach(cat => {
                    ul.appendChild(buildCategoryTree(cat, [...path, cat.name]));
                });
            }
            return ul;
        }

        function getNodeByPath(node, path) {
            if (path.length === 0) return node;
            const [head, ...rest] = path;
            const child = node.categories.find(c => c.name === head);
            if (!child) return node;
            return getNodeByPath(child, rest);
        }

        function collectFiles(node, basePath) {
            let files = [];
            if (node.files) {
                files = files.concat(node.files.map(f => ({
                    src: `${basePath}/${f}`,
                    name: f
                })));
            }
            if (node.categories) {
                node.categories.forEach(cat => {
                    files = files.concat(collectFiles(cat, `${basePath}/${cat.name}`));
                });
            }
            return files;
        }

        function renderCategorySidebar() {
            const sidebar = document.getElementById('category-list');
            sidebar.innerHTML = '';
            sidebar.appendChild(buildCategoryTree(skinsTree, []));
            highlightCategory();
        }

        function highlightCategory() {
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            const id = 'cat-' + currentPath.join('/');
            const el = document.getElementById(id);
            if (el) el.classList.add('active');
        }

        function renderGallery() {
            const browser = document.getElementById('file-browser');
            browser.innerHTML = '';
            const node = getNodeByPath(skinsTree, currentPath);
            const basePath = CATEGORY_ROOT + (currentPath.length ? '/' + currentPath.join('/') : '');
            const files = collectFiles(node, basePath);
            if (files.length === 0) {
                browser.innerHTML = `<div class='col-span-full text-center py-10 text-gray-400'><i class='fas fa-images text-4xl mb-2'></i><p>Немає зображень у цій категорії.</p></div>`;
                return;
            }
            files.forEach(file => {
                const div = document.createElement('div');
                div.className = 'file-item bg-gray-800 rounded-lg p-3 hover:bg-gray-700 transition-colors fade-in';
                div.innerHTML = `
                    <div class="image-container rounded-lg overflow-hidden mb-2">
                        <img src="${file.src}" alt="${file.name}" class="cursor-pointer view-image">
                    </div>
                    <div class="image-title text-center mb-2 cursor-pointer">${file.name}</div>
                    <div class="file-actions flex justify-center">
                        <button class="copy-btn bg-gray-700 hover:bg-gray-600 rounded-full w-8 h-8 flex items-center justify-center mr-1" title="Копіювати URL" data-url="${window.location.origin}/azubanskins/${file.src}">
                            <i class="fas fa-link text-sm"></i>
                        </button>
                    </div>
                `;
                // Копіювання URL
                div.querySelector('.copy-btn').onclick = (e) => {
                    const url = e.target.closest('button').getAttribute('data-url');
                    copyToClipboard(encodeURL(url));
                    showNotification('Посилання скопійовано!');
                };
                browser.appendChild(div);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchSkinsJson().then(tree => {
                skinsTree = { name: 'root', ...tree };
                renderCategorySidebar();
                renderGallery();
            });
        });
    </script>
</body>
</html>